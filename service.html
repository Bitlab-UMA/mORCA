<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Mr.Symbiomath</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.4/jquery.mobile-1.4.4.min.css" />
  <link rel="stylesheet" href="css/themes/Bitlab.css" />
  <link rel="stylesheet" href="css/themes/jquery.mobile.icons.min.css" />
  <link rel="stylesheet" href="css/service.css" />
  <script src="https://code.jquery.com/jquery-1.12.4.min.js"></script>
  <script src="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.js"></script>
  <script src="js/jquery.soap.js" type="text/javascript"></script>
  <script src="js/mAPI.js" type="text/javascript"></script>
  <script src="js/sAPI.js" type="text/javascript"></script>
  <script>



  var name, urlOperation, idOperation, repoID;
  var parameters = new Array();
  var resultfile = "";
  filesList = new Array();

  function loadServiceInfo() {
    name = String(window.location.href.split('?')[1])

    repoid = String(window.location.href.split('?')[2])
    repoid = decodeURI(repoid);

    toolid = String(window.location.href.split('?')[3])
    toolid = decodeURI(toolid)

    console.log(toolid);

    urlOperation = toolid + name;
    idOperation = toolid + name + ";" + name;

    repoID = repoid;
  };

  function processParameters() {
    if (logged()) {
      var d = new Date();
      d.setTime(d.getTime());
      var nameFile = document.getElementById("nameFile").value
      var idFolder = "";
      var token = getCookie("token");
      var user = getCookie("username");
      var inputList = new Array();
      var outputList = new Array();

      console.log("Processing DATA...");

      for (var x = 0; x < parameters.length; x++) {

        console.log("ParameterName: " + parameters[x].name)

        if (parameters[x].input == "true") {
          var parameter = new Array();
          var generatedID = 'parameter' + x + '';
          console.log("GeneratedID: " + generatedID);

          var para = document.getElementById('parameter' + x).value;
          // puede que haya un valor oculto correspondiente, si salió de una lista, entonces
          // cogerlo
          try {para = document.getElementById('parameterhidden' + x).value } catch(e){};

          parameter.push(para);

          // parameter.push(document.getElementById(generatedID).value.split("#")[0]);
          parameter.push(parameters[x].dataTypeID);
          parameter.push("Moby");
          parameter.push(parameters[x].name);
          parameter.push(null);
          parameter.push(null);
          parameter.push(parameters[x].type);

          if (document.getElementById("checkbox" + x)) {
            if (document.getElementById("checkbox" + x).checked) {
              parameter.push("true");
            } else {
              parameter.push("false");
            }

          } else {
            parameter.push("false");
          }

          inputList.push(parameter);
        }
      };

      for (var x = 0; x < parameters.length; x++) {
        if (parameters[x].input == "false") {

          var outParameter = new Array();
          outParameter.push(null);
          outParameter.push(parameters[x].dataTypeID);
          outParameter.push("");
          outParameter.push(parameters[x].name);
          outParameter.push(null);
          outParameter.push(null);
          outParameter.push(parameters[x].type);
          outParameter.push("false");

          outputList.push(outParameter);
        }
      }

      executeService(inputList, outputList, urlOperation, idOperation, nameFile, idFolder, token, user, repoID);

    } else {
      $.mobile.loading("hide");
      alert("Please, log in if you want to execute a service");
    }
  }

  window.nuevoParametro = function(id, hiddentext, text) {
    $("#popupMenu" + id).popup("close")
    $("#parameter" + id).val(text);
    $("#parameterhidden" + id).val(hiddentext);
    $('#checkbox' + id).prop('checked', true).checkboxradio('refresh');
    document.getElementById("runrun").disabled = false;
    $("#mainresults").text("");
    // poner un nombre adecuado, si no le han puesto ya uno
    // var currentFileName = $("#nameFile").value;
    var currentFileName = document.getElementById("nameFile").value;
    if (currentFileName.length > 0) {
      var posseparation = currentFileName.lastIndexOf(' give me a name!');
      if (posseparation == -1) {
        posseparation = currentFileName.indexOf('-WITH-')
      }
      if (posseparation >= 0) {
        currentFileName = currentFileName.substr(0,posseparation) + '-WITH-' + $("#parameter" + id).val() + '_' +fechaHoraExt();
      }
    } else {
      currentFileName = $("#parameter" + id).val() + '_' +fechaHoraExt()
    }
    document.getElementById("nameFile").value = currentFileName;

  }
  </script>
</head>

<body>
  <div data-role="page" id="main">

    <script>
    loadServiceInfo();

    document.write('<div data-role="header" data-position="fixed"><a href="index.html" data-icon="arrow-l" data-rel="back" data-direction="reverse">Back</a><h1>' + name + '</h1>');

    document.write('<a href="#popupLogin" id="loginButton" data-rel="popup" data-position-to="window" class="ui-btn ui-corner-all ui-shadow ui-btn-inline ui-icon-check ui-btn-icon-left ui-btn-a" data-transition="pop">Sign in</a></div>')

            if(!getCookie("username")) {
              document.write('<div id="popupLogin" data-role="popup" data-theme="a" class="ui-corner-all">' +
              '<a href="#" data-rel="back" data-role="button" data-theme="a" data-icon="delete"' +
              'data-iconpos="notext" class="ui-btn-right">Close</a>' +
              '<h3>Sign in</h3>' +
              '<label for="un" class="ui-hidden-accessible">Username:</label>' +
              '<input type="text" name="user" id="un" value="guest" placeholder="Username" data-theme="a">' +
              '<label for="pw" class="ui-hidden-accessible">Password:</label>' +
              '<input type="password" name="pass" id="pw" value="guest" placeholder="Password" data-theme="a">' +
              '<button id="loginpopbutton" class="ui-btn ui-corner-all ui-shadow ui-btn-b ui-btn-icon-left ui-icon-check">Sign in</button></div>');

              $("#loginpopbutton").click(function () {
                var userform = $('#popupLogin').find('input[name="user"]').val() || "guest";
                var passform = $('#popupLogin').find('input[name="pass"]').val() || "guest";
                mainLogin(userform, passform);
                $("#popupLogin").popup('close');
              })

            } else {
              $('#loginButton').html('logout');
              $('#loginButton').removeAttr('href');
              $('#loginButton').attr('onclick', 'mainLogout()');
              getRoot(getCookie('username'), getCookie('token'), '', repoid);
            }

    getParameters(idOperation, repoID, (function(array) {
      console.log(array);
      generateInterface(array, name);
      parameters = array;
    }));

    </script>

      <div id="serviceRunning"></div>

     <div id="mainresults" contenteditable style="margin-left: 10px;" disabled >
RESULTS…
    </div>

<!-- VIEWER -->
    <link type="text/css" rel="stylesheet" href="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/lib/style.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/lib/jquery-ui-slider-pips.css">
    <link type="text/css" rel="stylesheet" href="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/lib/slider/css/slider.css">
    <script src="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/d3.min.js"></script>
    <script src="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/lib/jquery-ui-slider-pips.js"></script>
    <script src="https://cdn.rawgit.com/rslprpr/biojs-vis-blast/master/lib/color-scheme.min.js"></script>
    <script src="https://wzrd.in/bundle/biojs-vis-blast@0.1.5"></script>
    <script src="https://wzrd.in/bundle/biojs-io-blast@latest"></script>
    <script src="https://wzrd.in/bundle/sequence-viewer@0.2.17"></script>



<!--  -->

  <div data-role="footer" data-position="fixed">
      <h4>&copy; 2016 Bioinformatics and Information Technology Laboratories</h4>
    </div>
  </div>
</body>

</html>
